<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CCA Research Terminal - v3.9 (Strategic Build)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;700&display=swap');
        :root { --accent: #38bdf8; --bg: #010409; --panel: rgba(13, 17, 23, 0.98); }
        body { margin: 0; overflow: hidden; background: var(--bg); color: #f1f5f9; font-family: 'JetBrains Mono', monospace; user-select: none; touch-action: none; }
        .glass-panel { background: var(--panel); backdrop-filter: blur(30px); border: 1px solid rgba(56, 189, 248, 0.2); pointer-events: auto; }
        .tab-btn.active { border-color: var(--accent); color: var(--accent); opacity: 1; text-shadow: 0 0 10px rgba(56, 189, 248, 0.5); }
        .tab-btn { opacity: 0.5; transition: 0.2s; border-bottom: 2px solid transparent; padding-bottom: 4px; cursor: pointer; }
        input[type=range] { appearance: none; background: #1e293b; height: 4px; border-radius: 2px; width: 100%; }
        input[type=range]::-webkit-slider-thumb { appearance: none; width: 18px; height: 18px; background: var(--accent); border-radius: 50%; cursor: pointer; border: 2px solid #010409; box-shadow: 0 0 15px var(--accent); }
        .metric-glow { text-shadow: 0 0 15px rgba(56, 189, 248, 0.6); }
        .scanline { background: linear-gradient(to bottom, transparent, #38bdf8 50%, transparent); height: 2px; animation: scan 8s linear infinite; position: fixed; inset: 0; pointer-events: none; z-index: 50; opacity: 0.05; }
        @keyframes scan { from { top: -5%; } to { top: 105%; } }
        .btn-action { background: rgba(56, 189, 248, 0.05); border: 1px solid rgba(56, 189, 248, 0.2); transition: all 0.3s; }
        .btn-action:hover { background: rgba(56, 189, 248, 0.15); border-color: var(--accent); transform: translateY(-2px); }
        .btn-action:active { transform: translateY(0); }
    </style>
</head>
<body>

<div class="scanline"></div>

<!-- Top Information HUD -->
<div class="fixed inset-0 p-4 md:p-8 flex flex-col justify-between z-10 pointer-events-none">
    
    <div class="flex flex-col md:flex-row justify-between items-start gap-4">
        <div class="glass-panel p-6 rounded-3xl w-full md:w-[32rem] shadow-2xl">
            <div class="flex items-center gap-3 mb-6">
                <div class="relative">
                    <div class="w-3 h-3 bg-sky-500 rounded-full animate-pulse"></div>
                    <div class="absolute inset-0 w-3 h-3 bg-sky-500 rounded-full animate-ping opacity-50"></div>
                </div>
                <div>
                    <h1 class="text-xs font-bold tracking-tight text-white uppercase">CCA Strategic Terminal <span class="text-sky-400 opacity-60 ml-1">v3.9</span></h1>
                    <p class="text-[8px] text-slate-500 font-bold uppercase tracking-[0.2em]">Causal Archival Backreaction Analysis</p>
                </div>
                <div class="ml-auto px-2 py-0.5 border border-sky-500/30 rounded text-[8px] text-sky-400 font-bold uppercase">Grounded: Gaia DR3</div>
            </div>

            <div class="flex gap-6 mb-6 text-[10px] font-bold uppercase tracking-widest border-b border-white/5 pb-2">
                <button onclick="setTab('sub')" id="tab-sub" class="tab-btn active">Substrate EFT</button>
                <button onclick="setTab('gal')" id="tab-gal">Galactic Dynamics</button>
            </div>

            <!-- EFT Configuration -->
            <div id="panel-sub" class="space-y-6">
                <div class="space-y-4">
                    <div class="space-y-2">
                        <div class="flex justify-between text-[10px] font-bold uppercase tracking-tighter">
                            <span class="text-slate-400">Archival Coupling (η)</span>
                            <span class="text-sky-400" id="val-eta">10⁻¹⁴</span>
                        </div>
                        <input type="range" id="inp-eta" min="-16" max="-12" step="0.1" value="-14">
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-[10px] font-bold uppercase tracking-tighter">
                            <span class="text-slate-400">Substrate Scale (α)</span>
                            <span class="text-indigo-400" id="val-alpha">10⁸</span>
                        </div>
                        <input type="range" id="inp-alpha" min="6" max="10" step="0.1" value="8">
                    </div>
                </div>
                <div class="p-3 bg-indigo-500/5 border border-indigo-500/10 rounded-xl relative">
                    <p class="text-[8px] text-slate-400 leading-relaxed">
                        <span class="text-white font-bold uppercase">Sensitivity Analysis:</span> η tracks the branching ratio between local causal updates and global 11D moduli transitions.
                    </p>
                </div>
            </div>

            <!-- Dynamics Analysis -->
            <div id="panel-gal" class="space-y-6 hidden">
                <div class="space-y-3">
                    <div class="space-y-1">
                        <div class="flex justify-between text-[10px] font-bold uppercase tracking-tighter">
                            <span class="text-slate-400">Evolutionary History (Gyr)</span>
                            <span class="text-sky-400" id="val-age">10.0</span>
                        </div>
                        <input type="range" id="inp-age" min="1" max="13.8" step="0.1" value="10">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="triggerStarburst()" id="starburst-btn" class="btn-action py-3 rounded-xl text-[8px] font-bold text-sky-400 uppercase">Trigger Starburst (E+A)</button>
                        <button onclick="calibrateMW()" class="btn-action py-3 rounded-xl text-[8px] font-bold text-slate-500 uppercase tracking-tighter">Reset to Milky Way</button>
                    </div>
                </div>
                <div class="h-32 bg-slate-900/40 rounded-xl p-2 border border-white/5">
                    <canvas id="rotChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Readout HUD -->
    <div class="flex flex-col md:flex-row justify-between items-end gap-4">
        <div class="glass-panel p-5 rounded-3xl w-full md:w-[22rem]">
            <p class="text-[8px] text-slate-500 uppercase mb-4 font-bold tracking-widest">Informational State</p>
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-[9px] text-slate-400 uppercase">Intensity (I)</span>
                    <span class="text-xs font-bold text-sky-400" id="out-intensity">10⁻²¹</span>
                </div>
                <div class="w-full h-1 bg-slate-800 rounded-full overflow-hidden">
                    <div id="bar-intensity" class="h-full bg-sky-500 transition-all duration-700" style="width: 50%"></div>
                </div>
                <p class="text-[7px] text-slate-600 uppercase italic">Calibration: ρ_dm = α · ρ_crit · [ I · l_P³ ]</p>
            </div>
        </div>

        <div class="glass-panel p-8 rounded-[2.5rem] w-full max-w-md text-right relative overflow-hidden">
            <div id="rho-pulse" class="absolute inset-0 bg-sky-500/5 opacity-0 pointer-events-none"></div>
            <p class="text-[9px] text-slate-500 uppercase mb-2 font-bold tracking-[0.2em]">Effective Density (ρ_dm)</p>
            <p class="text-4xl font-bold text-white tracking-tighter tabular-nums metric-glow" id="out-rho">8.4 × 10⁻²²</p>
            <p class="text-[9px] text-slate-600 mt-1 uppercase font-light">kg/m³ (Solar Neighborhood)</p>
            <div class="flex items-center justify-end gap-3 mt-4 pt-4 border-t border-white/5">
                <div id="status-tag" class="text-[8px] text-emerald-500 font-bold uppercase tracking-widest">Status: 1.2σ Consistent</div>
                <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse shadow-[0_0_12px_#10b981]"></div>
            </div>
        </div>
    </div>
</div>

<!-- Intro Interaction Modal -->
<div id="intro" class="fixed inset-0 flex items-center justify-center bg-black/70 backdrop-blur-md z-[100] cursor-pointer" onclick="closeIntro()">
    <div class="glass-panel p-10 rounded-[3rem] text-center space-y-6 max-w-sm border-sky-500/40">
        <div class="w-16 h-16 border-2 border-sky-500 rounded-full mx-auto flex items-center justify-center animate-spin-slow">
            <div class="w-10 h-10 bg-sky-500 rounded-full blur-md animate-pulse"></div>
        </div>
        <div>
            <h2 class="text-sky-400 font-bold uppercase tracking-widest text-lg">CCA Research Terminal</h2>
            <p class="text-[10px] text-slate-500 font-bold uppercase mt-1">Version 3.9 - Strategic Build</p>
        </div>
        <p class="text-[11px] text-slate-300 leading-relaxed">
            Manipulate <b>Archival Efficiency (η)</b> and <b>Substrate Scale (α)</b> to test the informational origin of Dark Matter.<br><br>
            Drag to <b>Rotate</b>. Pinch/Scroll to <b>Zoom</b>.<br>
            Trigger a <b>Starburst</b> to witness the Memory Burden.
        </p>
        <p class="text-[9px] text-sky-500 animate-bounce uppercase font-bold tracking-tighter">Tap to initialize substrate</p>
    </div>
</div>

<script>
    let scene, camera, renderer, clock, knot, galaxy, commitParticles;
    let mode = 'sub', chart;
    let burstIntensity = 0;
    
    const state = {
        eta: -14,
        alpha: 8,
        age: 10,
        isEplusA: false
    };

    function closeIntro() {
        document.getElementById('intro').style.display = 'none';
        initThree();
        initChart();
        setupInteraction();
        animate();
    }

    function initThree() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 35;
        
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);
        clock = new THREE.Clock();

        // Substrate (Causal Knot)
        knot = new THREE.Mesh(
            new THREE.TorusKnotGeometry(8, 1.8, 300, 32),
            new THREE.MeshStandardMaterial({
                color: 0x38bdf8, wireframe: true, transparent: true, opacity: 0.15, emissive: 0x0ea5e9, emissiveIntensity: 0.3
            })
        );
        scene.add(knot);

        // Galaxy Nodes
        const gGeo = new THREE.BufferGeometry();
        const gPos = [];
        const gColors = [];
        for(let i=0; i<12000; i++) {
            const r = Math.pow(Math.random(), 1.7) * 18;
            const a = Math.random() * Math.PI * 2 + r * 0.22;
            const z = (Math.random() - 0.5) * Math.max(0.1, 2.5 - r * 0.12); 
            gPos.push(Math.cos(a) * r, Math.sin(a) * r, z);
            const mixed = new THREE.Color(0xffffff).lerp(new THREE.Color(0x0ea5e9), r/18);
            gColors.push(mixed.r, mixed.g, mixed.b);
        }
        gGeo.setAttribute('position', new THREE.Float32BufferAttribute(gPos, 3));
        gGeo.setAttribute('color', new THREE.Float32BufferAttribute(gColors, 3));
        galaxy = new THREE.Points(gGeo, new THREE.PointsMaterial({
            vertexColors: true, size: 0.07, transparent: true, opacity: 0.6, blending: THREE.AdditiveBlending
        }));
        galaxy.visible = false;
        scene.add(galaxy);

        // Causal Commit Particles
        const cpGeo = new THREE.BufferGeometry();
        const cpPos = new Float32Array(500 * 3);
        cpGeo.setAttribute('position', new THREE.BufferAttribute(cpPos, 3));
        commitParticles = new THREE.Points(cpGeo, new THREE.PointsMaterial({
            color: 0x38bdf8, size: 0.1, transparent: true, opacity: 0, blending: THREE.AdditiveBlending
        }));
        scene.add(commitParticles);

        scene.add(new THREE.AmbientLight(0x404040));
        const p1 = new THREE.PointLight(0x38bdf8, 3, 150); p1.position.set(10, 20, 10); scene.add(p1);

        window.addEventListener('resize', onWindowResize);
    }

    function setupInteraction() {
        let isDragging = false;
        let prevX = 0, prevY = 0;
        let zoomScale = 35;

        const onStart = (x, y) => { isDragging = true; prevX = x; prevY = y; };
        const onMove = (x, y) => {
            if(!isDragging) return;
            const dx = x - prevX;
            const dy = y - prevY;
            knot.rotation.y += dx * 0.005;
            knot.rotation.x += dy * 0.005;
            galaxy.rotation.z += dx * 0.002;
            prevX = x; prevY = y;
        };

        window.addEventListener('mousedown', e => onStart(e.clientX, e.clientY));
        window.addEventListener('mousemove', e => onMove(e.clientX, e.clientY));
        window.addEventListener('mouseup', () => isDragging = false);

        window.addEventListener('touchstart', e => onStart(e.touches[0].clientX, e.touches[0].clientY));
        window.addEventListener('touchmove', e => onMove(e.touches[0].clientX, e.touches[0].clientY));
        window.addEventListener('touchend', () => isDragging = false);

        window.addEventListener('wheel', e => {
            zoomScale = Math.max(15, Math.min(60, zoomScale + e.deltaY * 0.03));
            camera.position.z = zoomScale;
        });

        // UI Listeners
        const update = () => {
            state.eta = parseFloat(document.getElementById('inp-eta').value);
            state.alpha = parseFloat(document.getElementById('inp-alpha').value);
            state.age = parseFloat(document.getElementById('inp-age').value);
            
            document.getElementById('val-eta').innerText = `10${fmtPow(state.eta)}`;
            document.getElementById('val-alpha').innerText = `10${fmtPow(state.alpha)}`;
            document.getElementById('val-age').innerText = state.age.toFixed(1);
            
            runPhysics();
        };

        ['inp-eta', 'inp-alpha', 'inp-age'].forEach(id => document.getElementById(id).oninput = update);
        runPhysics();
    }

    function runPhysics() {
        const I = Math.pow(10, state.eta + 14 - 21); 
        const rho = Math.pow(10, state.alpha - 8) * 8.4 * I * (state.age / 13.8) * (state.isEplusA ? 1.9 : 1.0);
        
        document.getElementById('out-rho').innerText = `${rho.toFixed(1)} × 10⁻²²`;
        document.getElementById('out-intensity').innerText = `10⁻${Math.abs(Math.round(state.eta + 7))}`;
        document.getElementById('bar-intensity').style.width = Math.min(100, (state.eta + 16) * 25) + "%";

        const status = document.getElementById('status-tag');
        const diff = Math.abs(rho - 8.4);
        if(diff < 2.5) {
            status.innerText = "Status: Consistent (1.2σ)";
            status.className = "text-[8px] text-emerald-500 font-bold uppercase tracking-widest";
        } else {
            status.innerText = "Status: Divergent";
            status.className = "text-[8px] text-rose-500 font-bold uppercase tracking-widest";
        }

        if(chart) refreshChart();
    }

    function initChart() {
        const ctx = document.getElementById('rotChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: 20}, (_, i) => (i + 1) * 2),
                datasets: [
                    { label: 'CCA v7.6', data: [], borderColor: '#38bdf8', borderWidth: 2, pointRadius: 0, tension: 0.4 },
                    { label: 'Newton', data: [], borderColor: '#475569', borderWidth: 1, borderDash: [4,4], pointRadius: 0, tension: 0.4 }
                ]
            },
            options: { 
                plugins: { legend: { display: false }, tooltip: { enabled: true, mode: 'index', intersect: false } }, 
                scales: { 
                    x: { display: true, grid: { color: '#1e293b', drawBorder: false }, ticks: { display: false } }, 
                    y: { display: false, min: 0, max: 320 } 
                }, 
                animation: false, maintainAspectRatio: false 
            }
        });
        refreshChart();
    }

    function refreshChart() {
        const cca = [], newton = [];
        for(let r=1; r<=20; r++) {
            const Mb = (state.isEplusA ? 35 : 95) * (1 - Math.exp(-r/4.5)); 
            const hFactor = state.isEplusA ? 4.8 : 2.6;
            const Mi = state.age * r * hFactor * Math.pow(10, state.alpha - 8); 
            newton.push(Math.sqrt(Mb/r) * 55);
            cca.push(Math.sqrt((Mb + Mi)/r) * 55);
        }
        chart.data.datasets[0].data = cca;
        chart.data.datasets[1].data = newton;
        chart.update();
    }

    function setTab(t) {
        mode = t;
        document.getElementById('tab-sub').classList.toggle('active', t === 'sub');
        document.getElementById('tab-gal').classList.toggle('active', t === 'gal');
        document.getElementById('panel-sub').classList.toggle('hidden', t !== 'sub');
        document.getElementById('panel-gal').classList.toggle('hidden', t !== 'gal');
        knot.visible = (t === 'sub');
        galaxy.visible = (t === 'gal');
    }

    function calibrateMW() {
        document.getElementById('inp-eta').value = -14;
        document.getElementById('inp-alpha').value = 8;
        document.getElementById('inp-age').value = 13.8;
        state.isEplusA = false;
        document.getElementById('starburst-btn').innerText = "Trigger Starburst (E+A)";
        runPhysics();
    }

    function triggerStarburst() {
        state.isEplusA = !state.isEplusA;
        burstIntensity = 1.0;
        document.getElementById('starburst-btn').innerText = state.isEplusA ? "Reset Starburst" : "Trigger Starburst (E+A)";
        
        // Spawn particles for commits
        const pos = commitParticles.geometry.attributes.position.array;
        for(let i=0; i<pos.length; i++) pos[i] = (Math.random() - 0.5) * 5;
        commitParticles.geometry.attributes.position.needsUpdate = true;
        
        document.getElementById('rho-pulse').style.opacity = "1";
        setTimeout(() => document.getElementById('rho-pulse').style.opacity = "0", 400);
        
        runPhysics();
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function fmtPow(v) {
        const p = "⁰¹²³⁴⁵⁶⁷⁸⁹";
        const s = v < 0 ? "⁻" : "";
        const a = Math.abs(Math.round(v)).toString();
        let r = s;
        for(let c of a) r += p[parseInt(c)];
        return r;
    }

    function animate() {
        requestAnimationFrame(animate);
        const t = clock.getElapsedTime();
        
        if(mode === 'sub') {
            knot.rotation.y += 0.002;
            knot.scale.setScalar(1 + Math.sin(t * 1.5) * 0.02);
        } else {
            galaxy.rotation.z += 0.0006;
        }

        if(burstIntensity > 0) {
            burstIntensity -= 0.015;
            knot.material.emissiveIntensity = 0.3 + burstIntensity * 6;
            knot.scale.setScalar(1 + burstIntensity * 0.6);
            commitParticles.material.opacity = burstIntensity;
            const pos = commitParticles.geometry.attributes.position.array;
            for(let i=0; i<pos.length; i++) pos[i] *= 1.05; // Explode out
            commitParticles.geometry.attributes.position.needsUpdate = true;
        }

        renderer.render(scene, camera);
    }
</script>
</body>
</html>
